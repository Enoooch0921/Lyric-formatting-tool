<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™æœƒæ­Œè©æ’ç‰ˆåŠ©æ‰‹ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; /* Indigo 600 */
            --primary-hover: #4338ca;
            --secondary: #64748b; /* Slate 500 */
            --success: #10b981; /* Emerald 500 */
            --danger: #ef4444; /* Red 500 */
            --bg-color: #f1f5f9; /* Slate 100 */
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --border-color: #e2e8f0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            color: var(--primary);
            margin: 0;
            font-weight: 700;
            font-size: 2rem;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: var(--secondary);
            font-size: 1rem;
            margin-top: 8px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        /* Controls Area */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        @media (min-width: 768px) {
            .controls-grid {
                grid-template-columns: auto 1fr auto; /* å·¦è¨­å®š ä¸­å·¥å…· å³å±éšªå€ */
                align-items: center;
            }
        }

        .control-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .group-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 8px;
        }

        /* Inputs */
        .input-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-color);
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        input[type="number"] {
            border: none;
            background: transparent;
            width: 50px;
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            outline: none;
        }

        /* Buttons */
        button {
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        button:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover { background-color: var(--primary-hover); box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.4); transform: translateY(-1px); }

        .btn-outline {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .btn-outline:hover { background-color: var(--bg-color); border-color: #cbd5e1; }

        .btn-soft {
            background-color: #e0e7ff; /* Indigo 100 */
            color: var(--primary);
        }
        .btn-soft:hover { background-color: #c7d2fe; }

        .btn-danger-ghost {
            background: transparent;
            color: var(--danger);
            border: 1px solid transparent;
        }
        .btn-danger-ghost:hover { background: #fef2f2; border-color: #fecaca; }

        /* Translation Tools Bar */
        .tools-bar {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border-color);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Editor Area */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            height: 60vh;
        }

        @media (min-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .editor-box {
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden; /* For header rounded corners */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .editor-header {
            background: #f8fafc;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 700;
            color: var(--secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        textarea {
            flex: 1;
            padding: 20px;
            border: none;
            resize: none;
            font-size: 16px;
            line-height: 1.7;
            font-family: inherit;
            color: var(--text-main);
        }

        textarea:focus {
            outline: none;
            background-color: #fafafa;
        }

        textarea::placeholder {
            color: #94a3b8;
        }

        /* Output specific styles */
        #outputLyrics {
            background-color: #f8fafc;
        }

        .btn-copy {
            background-color: var(--success);
            color: white;
            font-size: 0.85rem;
            padding: 6px 12px;
        }
        .btn-copy:hover { background-color: #059669; }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>æ•™æœƒæ­Œè©æ’ç‰ˆåŠ©æ‰‹ Pro</h1>
            <div class="subtitle">æ™ºæ…§é˜²å­¤å…’å­—ãƒ»è‡ªå‹•æ¨™æ®µãƒ»ç¿»è­¯ç®¡ç†ãƒ»ä¸åˆ‡æ–·è©å½™</div>
        </header>

        <div class="card">
            <div class="controls-grid">
                <div class="control-group">
                    <div class="input-wrapper" title="æ¯è¡Œå­—æ•¸åƒè€ƒï¼ˆä¸­æ–‡=2ï¼Œè‹±æ–‡=1ï¼‰">
                        <span style="font-size: 0.9rem; color: var(--secondary); margin-right:5px;">è¡Œå¯¬é™åˆ¶</span>
                        <input type="number" id="charLimit" value="13" min="5" max="40">
                    </div>
                </div>

                <div class="control-group" style="justify-content: center;">
                    <button class="btn-primary" onclick="formatLyrics()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        ä¸€éµæ ¼å¼åŒ–
                    </button>
                    <button class="btn-outline" onclick="replaceText('ä½ ', 'ç¥¢')">ä½  â†’ ç¥¢</button>
                    <button class="btn-outline" onclick="replaceText('ä»–', 'ç¥‚')">ä»– â†’ ç¥‚</button>
                </div>

                <div class="control-group" style="justify-content: flex-end;">
                    <button class="btn-danger-ghost" onclick="clearAll()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        æ¸…ç©º
                    </button>
                </div>
            </div>

            <div class="tools-bar">
                <span class="group-label">ç¿»è­¯ç®¡ç†å·¥å…·</span>
                <button class="btn-soft" onclick="keepChineseOnly()" title="ä¿ç•™ä¸­æ–‡">
                    ğŸ‡¨ğŸ‡³ åªç•™ä¸­æ–‡
                </button>
                <button class="btn-soft" onclick="keepEnglishOnly()" title="ä¿ç•™è‹±æ–‡">
                    ğŸ‡ºğŸ‡¸ åªç•™è‹±æ–‡
                </button>
                <button class="btn-soft" onclick="keepOddLines()" title="å»é™¤é›™èªæ­Œè©ä¸­çš„ç¿»è­¯è¡Œ">
                    ğŸ”¢ ç§»é™¤é›™æ•¸è¡Œ
                </button>
            </div>
        </div>

        <div class="editor-container">
            <div class="editor-box">
                <div class="editor-header">
                    <span class="editor-title">åŸå§‹æ­Œè©</span>
                </div>
                <textarea id="inputLyrics" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ­Œè©...&#10;&#10;ğŸ’¡ åŠŸèƒ½æç¤ºï¼š&#10;1. é˜²å­¤å…’å­—ï¼šæœ«å°¾å–®å­—è‹¥è¶…å‡ºä¸€é»é»ï¼Œæœƒè‡ªå‹•æ“ åœ¨åŒä¸€è¡Œ&#10;2. è‡ªå‹•æ¨™æ®µï¼šè¼¸å…¥ V1, C, B, Pre è‡ªå‹•è­˜åˆ¥&#10;3. æ™ºæ…§ç³¾éŒ¯ï¼šä¿®æ­£ Pro Chorus, Brisge ç­‰æ‹¼å¯«éŒ¯èª¤"></textarea>
            </div>

            <div class="editor-box">
                <div class="editor-header">
                    <span class="editor-title">æ’ç‰ˆçµæœ</span>
                    <button id="copyBtn" class="btn-copy" onclick="copyToClipboard()">
                        ğŸ“‹ è¤‡è£½çµæœ
                    </button>
                </div>
                <textarea id="outputLyrics" readonly placeholder="æ ¼å¼åŒ–å¾Œçš„çµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
            </div>
        </div>
    </div>

    <script>
        function fullWidthToHalfWidth(str) {
            return str.replace(/[\uff01-\uff5e]/g, function(ch) {
                return String.fromCharCode(ch.charCodeAt(0) - 0xfee0);
            }).replace(/\u3000/g, ' ');
        }

        function getVisualLength(str) {
            let len = 0;
            for (let i = 0; i < str.length; i++) {
                if (str.charCodeAt(i) <= 127) len += 1;
                else len += 2;
            }
            return len;
        }

        function formatLyrics() {
            const inputElement = document.getElementById('inputLyrics');
            const visualLimit = (parseInt(document.getElementById('charLimit').value) || 12) * 2;
            let inputLyrics = inputElement.value;

            let processed = fullWidthToHalfWidth(inputLyrics);
            // ç§»é™¤æ¨™é»ï¼Œä¿ç•™ç©ºæ ¼ä½œç‚ºå”¯ä¸€çš„åˆ†å‰²ä¾æ“š
            processed = processed.replace(/[ï¼Œã€‚ã€ï¼›ï¼šâ€œâ€ï¼ˆï¼‰ã€Šã€‹ã€Œã€,.:;"'?!()~]/g, ' ');

            const lines = processed.split('\n');
            let formattedLines = [];

            lines.forEach(line => {
                let cleanedLine = line.replace(/\s+/g, ' ').trim();
                if (cleanedLine === "") return;

                let label = "";
                let content = cleanedLine;
                const lowerLine = cleanedLine.toLowerCase();

                // æ¨™ç±¤èˆ‡ç³¾éŒ¯é‚è¼¯
                const verseMatch = lowerLine.match(/^\[?(v|verse)\s*([0-9]+)\]?/i);
                // æ–°å¢ pro chorus æ”¯æ´
                const tagMatch = lowerLine.match(/^\[?(chorus|chrous|chrouse|chros|c|bridge|br|brisge|brigde|b|pre(-)?chorus|pre(-)?chrous|pre|pre(-)?c|pro(-)?chorus|pro(-)?c)\]?(\s|:|\.|$)/i);

                if (verseMatch) {
                    label = `[${verseMatch[2]}]`;
                    content = cleanedLine.substring(verseMatch[0].length).trim();
                } 
                else if (tagMatch) {
                    let tag = tagMatch[1].replace(/-/g, '');
                    if (tag.startsWith('c')) label = `[chorus]`;
                    else if (tag.startsWith('b')) label = `[bridge]`;
                    else if (tag.startsWith('p')) label = `[prechorus]`; // Covers Pre & Pro
                    content = cleanedLine.substring(tagMatch[0].length).trim();
                } 
                else {
                    const firstChar = lowerLine.charAt(0);
                    const isDigit = ['1','2','3','4','5'].includes(firstChar);
                    
                    if (isDigit) {
                        label = `[${firstChar}]`;
                        content = content.substring(1).trim();
                    } 
                    else if (['c', 'b', 'p'].includes(firstChar)) {
                        const nextChar = lowerLine.charAt(1);
                        const isNextEnglish = nextChar >= 'a' && nextChar <= 'z';
                        if (!isNextEnglish) {
                            if (firstChar === 'c') label = `[chorus]`;
                            else if (firstChar === 'b') label = `[bridge]`;
                            else if (firstChar === 'p') label = `[prechorus]`;
                            content = content.substring(1).trim();
                        }
                    }
                }

                if (label !== "" && content === "") {
                    formattedLines.push(label);
                    return;
                }
                if (label !== "") formattedLines.push(label);
                
                // æ–·è¡Œè™•ç† (å«å­¤å…’å­—é˜²è­·)
                if (content !== "") {
                    const segments = content.split(' ');
                    
                    if (segments.length > 0) {
                        let currentLine = "";
                        let currentLen = 0;

                        segments.forEach((segment, index) => {
                            if (segment === "") return; 

                            const segmentLen = getVisualLength(segment);
                            const spaceWidth = (currentLine !== "") ? 1 : 0;

                            // å­¤å…’å­—é˜²è­·é‚è¼¯ï¼š
                            // å¦‚æœæ˜¯é€™ä¸€è¡Œçš„æœ€å¾Œä¸€å€‹å­—ï¼Œçµ¦äºˆé¡å¤–çš„å®¹å¿åº¦ (5å€‹å–®ä½ï¼Œç´„2.5å€‹ä¸­æ–‡å­—æˆ–5å€‹è‹±æ–‡å­—æ¯)
                            const isLastWord = (index === segments.length - 1);
                            const tolerance = isLastWord ? 5 : 0;

                            if (currentLen + spaceWidth + segmentLen > visualLimit + tolerance && currentLine !== "") {
                                formattedLines.push(currentLine);
                                currentLine = segment;
                                currentLen = segmentLen;
                            } else {
                                currentLine += (currentLine === "" ? "" : " ") + segment;
                                currentLen += spaceWidth + segmentLen;
                            }
                        });
                        
                        if (currentLine) formattedLines.push(currentLine);
                    }
                }
            });

            // è¼¸å‡º
            let finalOutput = "";
            for (let i = 0; i < formattedLines.length; i++) {
                const line = formattedLines[i];
                if (line.startsWith('[')) {
                    finalOutput += line + "\n";
                } else {
                    finalOutput += line + "\n\n";
                }
            }

            document.getElementById('outputLyrics').value = finalOutput.trim();
        }

        // ç¿»è­¯èˆ‡å…¶ä»–å·¥å…·
        function keepChineseOnly() {
            const inputEl = document.getElementById('inputLyrics');
            const lines = inputEl.value.split('\n');
            const filtered = lines.filter(line => {
                if(line.trim() === "") return true;
                if(line.trim().match(/^\[|^verse|^chorus|^bridge|^c$|^b$|^1$/i)) return true;
                return /[\u4e00-\u9fa5]/.test(line);
            });
            inputEl.value = filtered.join('\n');
            formatLyrics();
        }

        function keepEnglishOnly() {
            const inputEl = document.getElementById('inputLyrics');
            const lines = inputEl.value.split('\n');
            const filtered = lines.filter(line => {
                if(line.trim() === "") return true;
                if(line.trim().match(/^\[|^verse|^chorus|^bridge|^c$|^b$|^1$/i)) return true;
                return !/[\u4e00-\u9fa5]/.test(line);
            });
            inputEl.value = filtered.join('\n');
            formatLyrics();
        }

        function keepOddLines() {
            if(!confirm("é€™æœƒåˆªé™¤æ¯å…©è¡Œä¸­çš„ç¬¬äºŒè¡Œï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            const inputEl = document.getElementById('inputLyrics');
            const lines = inputEl.value.split('\n').filter(l => l.trim() !== "");
            let resultLines = [];
            let contentCounter = 0;
            
            lines.forEach(line => {
                const isTag = line.match(/^\[|^verse|^chorus|^bridge|^pre|^c$|^b$|^p$|^[1-5]$/i);
                if (isTag) {
                    resultLines.push(line);
                } else {
                    contentCounter++;
                    if (contentCounter % 2 === 1) {
                        resultLines.push(line);
                    }
                }
            });
            inputEl.value = resultLines.join('\n');
            formatLyrics();
        }

        function replaceText(from, to) {
            const outputEl = document.getElementById('outputLyrics');
            if(!outputEl.value) formatLyrics();
            outputEl.value = outputEl.value.split(from).join(to);
        }

        function clearAll() {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')) {
                document.getElementById('inputLyrics').value = '';
                document.getElementById('outputLyrics').value = '';
            }
        }

        async function copyToClipboard() {
            const outputText = document.getElementById('outputLyrics');
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerHTML;
            
            if (!outputText.value.trim()) {
                alert("æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½å–”ï¼è«‹å…ˆè¼¸å…¥æ­Œè©ä¸¦æ ¼å¼åŒ–ã€‚");
                return;
            }

            try {
                await navigator.clipboard.writeText(outputText.value);
                btn.innerHTML = "âœ… å·²è¤‡è£½ï¼";
                btn.style.backgroundColor = "#059669"; // Emerald 600
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = "";
                }, 2000);
            } catch (err) { alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'); }
        }
    </script>
</body>
</html>
